---
title: "Untitled"
format: html
---

```{ojs}
data = FileAttachment("data/ContinenteDistritos_geo.geojson").json()
rawData = FileAttachment("data/legislativas_raw.json").json()
tbl = cleanElectionData(rawData)

html`<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />`

mapDiv = html`<div style="height: 400px;"></div>`

map = L.map(mapDiv, {
    zoomControl: false,
    dragging: false,
    scrollWheelZoom: false
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

mutable selectedDistrito = "Aveiro";

distritos = L.geoJSON(data, {
    style: (feat) => {
        const distrito = feat.properties.Distrito;
        const vencedor = votosPorDistrito(distrito)[0]?.partido;
        const intensidade = calcularIntensidade(selectedDistrito, distrito);

        return {
            fillColor: getPartyColors()[vencedor] ?? "#b3afafab",
            fillOpacity: intensidade,
            color: "#4b4b4b",
            weight: 1
        };
    },

    onEachFeature: (feat, layer) => {
        layer.bindTooltip(feat.properties.Distrito, {sticky: true });

        layer.on("click", () => {
            selectedDistrito = feat.properties.Distrito;
        });
    }
}).addTo(map);


Inputs.table(votosPorDistrito(selectedDistrito), {
    columns: ["partido", "votos"]
});

function cleanElectionData(rawData) {
    const cleaned = {"Inscritos": {}, "Votantes": {}};
    rawData.forEach(row => {
        const district = row["Círculo"];
        if (district && district !== "Total") {
            cleaned["Inscritos"][district] = parseInt(row["Inscritos"]);

        }
    });
}


function getPartyColors() {
    return {
        "PS": "#ff0000",
        "PPD/PSD.CDS-PP": "#ff9900",
        "CH": "#0000ff",
        "IL": "#00ffff",
        "B.E.": "#ff00ff",
        "PCP-PEV": "#008000",
        "L": "#800080",
        "PAN": "#00ff00"
    };
}

function votosPorDistrito(distritoNome) {
    const result = [];

    for (const [partido, distritos] of Object.entries(tbl)) {
        if (partido !== "Inscritos" && partido !== "Votantes") {
            const votos = distritos[distritoNome];
            if (votos !== undefined) {
                result.push({partido, votos});
            }
        }
    }
    return result.sort((a,b) => b.votos - a.votos);
}

function getPartidos() {
    return Object.keys(tbl).filter(partido => partido !== "Inscritos" && partido !== "Votantes");
}

function partyVotesByDistrict(partido) {
    const result = [];
    const dadosPartido = tbl[partido];

    for (const [distrito, votos] of Object.entries(dadosPartido)) {
        result.push({distrito, votos});
    }
    return result.sort((a, b) => b.votos - a.votos);
}

function calcularIntensidade(selected, current) {
    return selected === current ? 1 : 0.5;
}

function encontrarMenorAbstencao() {
    let menorTaxa = 100;
    let distritoMenor = "";

    for (const [distrito, inscritos] of Object.entries(tbl.Inscritos)) {
        if (distrito !== "Total") {
            const taxa = 100 - (tbl.Votantes[distrito] / inscritos * 100);
            if (taxa < menorTaxa) {
                menorTaxa = taxa;
                distritoMenor = distrito;
            }
        }
    }
    return distritoMenor;
}

function convertByParty() {
    const root = {name: "Portugal", children: [] };

    getPartidos().forEach(partido => {
        const partidoNode = { name: partido, children: [] };

        for (const [distrito, votos] of Object.entries(tbl[partido])) {
            partidoNode.children.push({ name: distrito, value: votos });
        }

        root.children.push(partidoNode);
    });
    return root;
}
```